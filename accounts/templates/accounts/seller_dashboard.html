{% extends 'base.html' %}
{% load static %}

{% block title %}Seller Dashboard{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">üëã {{ user.username|capfirst }}'s Seller Dashboard</h1>
    <hr>

    {% include 'messages.html' %}

    <div class="row">

        <!-- Profile Card -->
        <div class="col-md-4 mb-4">
            <div class="card text-center shadow-sm">
                <!-- AVATAR LOGIC: Use safe check (.name) and apply styling -->
                        {% if user.profile.profile_image.name %}
                            <img src="{{ user.profile.profile_image.url }}" 
                                 class="rounded-circle me-2"
                                 style="width: 30px; height: 30px; object-fit: cover;"
                                 alt="{{ user.username }}">
                        {% else %}
                            <img src="{% static 'img/default_avatar.png' %}"
                                 class="rounded-circle me-2"
                                 style="width: 30px; height: 30px; object-fit: cover;"
                                 alt="Default Avatar">
                        {% endif %}
                        <!-- END AVATAR LOGIC -->

                <div class="card-body">
                    <h5 class="card-title">{{ user.profile.full_name|default:user.username }}</h5>
                    <p class="card-text text-muted">{{ user.email }}</p>
                    <a href="{% url 'profile_update' %}" class="btn btn-outline-primary btn-sm">Edit Profile</a>
                </div>

                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        üí∞ Total Earnings:
                        <span class="fw-bold">${{ total_earnings|floatformat:2 }}</span>
                    </li>
                    <li class="list-group-item">
                        üì¶ Total Orders:
                        <span class="fw-bold">{{ total_orders }}</span>
                    </li>
                    <li class="list-group-item">
                        ‚≠ê Average Rating:
                        <span class="fw-bold">N/A</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Right Column -->
        <div class="col-md-8">

            <!-- Latest Orders -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    Latest Orders Received
                </div>

                <div class="card-body">
                    {% if latest_orders %}
                        <ul class="list-group list-group-flush">
                            {% for order in latest_orders %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <a href="{% url 'order_detail' pk=order.pk %}">
                                        {{ order.service.title|truncatechars:40 }}
                                    </a>
                                    <small class="text-muted d-block">Client: {{ order.client.username }}</small>
                                </div>

                                <span class="badge 
                                    {% if order.status == 'COMPLETED' %}bg-success
                                    {% elif order.status == 'IN_PROGRESS' %}bg-info
                                    {% elif order.status == 'PENDING' %}bg-warning
                                    {% elif order.status == 'CANCELLED' %}bg-danger
                                    {% endif %}">
                                    {{ order.get_status_display }}
                                </span>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No recent orders yet.</p>
                    {% endif %}

                    <a href="{% url 'seller_orders' %}" class="btn btn-link mt-3">View All Orders</a>
                </div>
            </div>

            <!-- Service Management -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-success text-white">
                    Service Management
                </div>
                <div class="card-body">
                    <a href="{% url 'service_create' %}" class="btn btn-success me-2">
                        ‚ûï Create New Service
                    </a>
                    <a href="{% url 'my_services' %}" class="btn btn-outline-info">
                        üìã View/Edit My Services
                    </a>
                </div>
            </div>

            <!-- Order Statistics Chart -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    Order Statistics
                </div>
                <div class="card-body"
                     data-order-stats
                     data-pending="{{ pending_orders }}"
                     data-in-progress="{{ in_progress_orders }}"
                     data-completed="{{ completed_orders }}"
                     data-cancelled="{{ cancelled_orders }}"
                     style="height: 300px;">
                    <canvas id="orderStatusChart"></canvas>
                </div>
            </div>

            <!-- Earnings Trend Chart -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    Earning Trend
                </div>
                <div class="card-body"
                     data-earnings-data
                     data-months='{{ monthly_earnings_data.months|safe }}'
                     data-earnings='{{ monthly_earnings_data.earnings|safe }}'
                     style="height: 300px;">
                    <canvas id="earningsTrendChart"></canvas>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {

    /* ---------------------------
       ORDER STATUS CHART
    ----------------------------*/
    const orderStatsBox = document.querySelector('[data-order-stats]');
    if (orderStatsBox) {
        const pending = orderStatsBox.dataset.pending;
        const progress = orderStatsBox.dataset.inProgress;
        const completed = orderStatsBox.dataset.completed;
        const cancelled = orderStatsBox.dataset.cancelled;

        new Chart(document.getElementById('orderStatusChart'), {
            type: 'pie',
            data: {
                labels: ['Pending', 'In Progress', 'Completed', 'Cancelled'],
                datasets: [{
                    data: [pending, progress, completed, cancelled]
                }]
            }
        });
    }

    /* ---------------------------
       EARNINGS TREND CHART
    ----------------------------*/
    const earningBox = document.querySelector('[data-earnings-data]');
    if (earningBox) {
        const months = JSON.parse(earningBox.dataset.months);
        const earnings = JSON.parse(earningBox.dataset.earnings);

        new Chart(document.getElementById('earningsTrendChart'), {
            type: 'line',
            data: {
                labels: months,
                datasets: [{
                    label: 'Earnings ($)',
                    data: earnings,
                    fill: true,
                    tension: 0.3
                }]
            }
        });
    }
});
</script>
{% endblock %}
